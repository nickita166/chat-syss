<!DOCTYPE html>
<html>
<head>
    <title>Black Group Chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #000; 
            color: #e0e0e0;
            height: 100vh; 
            overflow: hidden;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        .name-screen { 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            background: #000;
        }
        .name-container { 
            text-align: center; 
            padding: 2rem;
        }
        .name-container h2 { 
            font-size: 2.5rem; 
            margin-bottom: 2rem; 
            color: #fff;
        }
        #nameInput { 
            background: #1a1a1a; 
            border: 2px solid #333; 
            border-radius: 12px; 
            padding: 1rem 1.5rem; 
            font-size: 1.2rem; 
            color: #e0e0e0; 
            width: 300px; 
            margin-bottom: 1.5rem;
            transition: border-color 0.3s;
        }
        #nameInput:focus { 
            outline: none; 
            border-color: #00ff88;
        }
        #setNameBtn { 
            background: linear-gradient(135deg, #00ff88, #00cc6a); 
            border: none; 
            border-radius: 12px; 
            padding: 1rem 2.5rem; 
            font-size: 1.2rem; 
            font-weight: 600; 
            color: #000; 
            cursor: pointer; 
            transition: transform 0.2s;
        }
        #setNameBtn:hover { transform: scale(1.05); }
        
        .chat-screen { display: none; height: 100vh; }
        .header { 
            background: #111; 
            padding: 1rem 2rem; 
            border-bottom: 1px solid #333;
        }
        .header h2 { color: #fff; }
        .group-section { 
            background: #1a1a1a; 
            padding: 1rem 2rem; 
            border-bottom: 1px solid #333;
            display: flex; gap: 1rem; align-items: center;
        }
        #groupSelect { 
            flex: 1; 
            background: #2a2a2a; 
            border: 1px solid #444; 
            border-radius: 8px; 
            padding: 0.8rem; 
            color: #e0e0e0;
        }
        .btn { 
            background: #00ff88; 
            border: none; 
            border-radius: 8px; 
            padding: 0.8rem 1.5rem; 
            color: #000; 
            font-weight: 600; 
            cursor: pointer;
        }
        .messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 2rem; 
            background: #000;
        }
        .message { 
            margin-bottom: 1.5rem; 
            animation: fadeIn 0.3s;
        }
        .message .user { 
            font-weight: 600; 
            color: #00ff88; 
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }
        .message .text { 
            background: #1a1a1a; 
            padding: 1rem 1.5rem; 
            border-radius: 18px; 
            display: inline-block;
            max-width: 70%;
        }
        .input-section { 
            background: #1a1a1a; 
            padding: 1.5rem 2rem; 
            border-top: 1px solid #333;
            display: flex; gap: 1rem;
        }
        #messageInput { 
            flex: 1; 
            background: #2a2a2a; 
            border: 1px solid #444; 
            border-radius: 25px; 
            padding: 1rem 1.5rem; 
            color: #e0e0e0; 
            font-size: 1rem;
        }
        #sendBtn { 
            width: 60px; 
            height: 50px; 
            border-radius: 50%; 
            font-size: 1.2rem;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <!-- Name Entry -->
        <div id="name-screen" class="name-screen">
            <div class="name-container">
                <h2>Enter Your Name</h2>
                <input id="nameInput" placeholder="Your name (max 20 chars)" maxlength="20">
                <button id="setNameBtn">Start Chatting</button>
            </div>
        </div>

        <!-- Chat Screen -->
        <div id="chat-screen" class="chat-screen">
            <div class="header">
                <h2 id="currentGroup">No Group</h2>
            </div>
            <div class="group-section">
                <select id="groupSelect">
                    <option value="">Select or create group</option>
                </select>
                <button id="createGroupBtn" class="btn">New Group</button>
            </div>
            <div id="messages" class="messages"></div>
            <div class="input-section">
                <input id="messageInput" placeholder="Type a message..." disabled>
                <button id="sendBtn" disabled>Send</button>
            </div>
        </div>
    </div>

    <script>
        let user = '';
        let currentGroup = '';

        // Wait for DOM
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            document.getElementById('setNameBtn').addEventListener('click', setName);
            document.getElementById('nameInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') setName();
            });
        }

        async function setName() {
            user = document.getElementById('nameInput').value.trim().substring(0, 20);
            if (!user) return alert('Please enter a name');
            
            document.getElementById('name-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('messageInput').disabled = false;
            
            loadGroups();
            startAutoRefresh();
        }

        async function loadGroups() {
            try {
                const res = await fetch('/api/groups');
                const codes = await res.json();
                const select = document.getElementById('groupSelect');
                select.innerHTML = '<option value="">Select or create group</option>';
                codes.forEach(code => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = code;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Failed to load groups');
            }
        }

        document.getElementById('createGroupBtn').addEventListener('click', createGroup);
        document.getElementById('groupSelect').addEventListener('change', joinGroup);
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') sendMessage();
        });

        async function createGroup() {
            try {
                const res = await fetch('/api/create-group', { method: 'POST' });
                const data = await res.json();
                joinGroup(data.code);
            } catch (e) {
                alert('Failed to create group');
            }
        }

        async function joinGroup(code = null) {
            const inputCode = code || document.getElementById('groupSelect').value.trim().toUpperCase();
            if (inputCode && inputCode !== currentGroup) {
                currentGroup = inputCode;
                document.getElementById('currentGroup').textContent = currentGroup;
                document.getElementById('sendBtn').disabled = false;
                loadMessages();
            }
        }

        async function loadMessages() {
            if (!currentGroup) return;
            try {
                const res = await fetch(`/api/messages/${currentGroup}`);
                const messages = await res.json();
                displayMessages(messages);
            } catch (e) {
                console.error('Failed to load messages');
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = messages.map(msg => `
                <div class="message">
                    <div class="user">${escapeHtml(msg.user)} <span style="color: #888; font-size: 0.8rem;">${msg.timestamp}</span></div>
                    <div class="text">${escapeHtml(msg.text)}</div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const text = document.getElementById('messageInput').value.trim();
            if (!text || !currentGroup || !user) return;
            
            try {
                const res = await fetch(`/api/messages/${currentGroup}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text, 
                        timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        username: user 
                    })
                });
                if (res.ok) {
                    document.getElementById('messageInput').value = '';
                    loadMessages();
                }
            } catch (e) {
                alert('Failed to send message');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function startAutoRefresh() {
            setInterval(loadGroups, 30000);  // Refresh groups every 30s
            setInterval(() => { if (currentGroup) loadMessages(); }, 3000);  // Messages every 3s
        }
    </script>
</body>
</html>
