<!DOCTYPE html>
<html>
<head>
    <title>Group Chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #000000; 
            color: #e0e0e0;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            background: #000000;
        }
        .name-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: #000000;
        }
        .name-container {
            background: #1a1a1a;
            padding: 50px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .name-container h2 {
            color: #ffffff;
            margin-bottom: 25px;
            font-size: 28px;
        }
        #nameInput {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            background: #2a2a2a;
            border: 2px solid #333;
            border-radius: 10px;
            color: #ffffff;
            font-size: 16px;
        }
        #setNameBtn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #28a745, #218838);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }
        .error { color: #ff4757; margin-top: 10px; }
        header { 
            background: #1a1a1a; 
            color: #ffffff; 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #333;
        }
        .groups-section { 
            background: #1a1a1a; 
            padding: 20px; 
            border-bottom: 1px solid #333; 
        }
        .group-controls { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
        }
        .group-controls input, .group-controls button, .group-controls select { 
            padding: 12px 16px; 
            border: 2px solid #333; 
            border-radius: 8px; 
            font-size: 14px; 
            background: #2a2a2a; 
            color: #ffffff;
            flex: 1;
            min-width: 150px;
        }
        .group-controls button { 
            background: linear-gradient(135deg, #28a745, #218838); 
            border: none; 
            cursor: pointer; 
            font-weight: 500;
        }
        .current-group { 
            font-weight: bold; 
            color: #007bff; 
            margin-top: 10px; 
            font-size: 18px; 
            background: rgba(0,123,255,0.1); 
            padding: 10px; 
            border-radius: 8px;
        }
        .messages { 
            flex: 1; 
            overflow-y: auto; 
            background: #111111; 
            padding: 20px; 
        }
        .message { 
            margin-bottom: 18px; 
            padding: 12px; 
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
        }
        .message .user { 
            font-weight: 600; 
            color: #007bff; 
            font-size: 14px; 
        }
        .message .time { 
            color: #888; 
            font-size: 12px; 
            margin-left: 10px; 
        }
        .message .text { 
            margin-top: 4px; 
            padding: 10px 14px; 
            background: rgba(0,123,255,0.1); 
            border-radius: 20px; 
            display: inline-block; 
            max-width: 75%; 
            word-wrap: break-word;
        }
        .message-form { 
            padding: 20px; 
            background: #1a1a1a; 
            border-top: 1px solid #333; 
            display: flex; 
            gap: 12px; 
        }
        #msgInput { 
            flex: 1; 
            padding: 16px 20px; 
            border: 2px solid #333; 
            border-radius: 25px; 
            font-size: 15px; 
            background: #2a2a2a; 
            color: #ffffff;
        }
        .message-form button { 
            padding: 16px 24px; 
            background: linear-gradient(135deg, #007bff, #0056b3); 
            color: white; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            font-weight: 500; 
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Name Entry Screen -->
        <div id="name-screen" class="name-screen">
            <div class="name-container">
                <h2>Enter Your Name</h2>
                <input id="nameInput" placeholder="Your name (max 20 chars)" maxlength="20">
                <button onclick="setUserName()">Start Chatting</button>
                <div id="nameError" class="error"></div>
            </div>
        </div>

        <!-- Main Chat -->
        <div id="chat-section" class="chat-section" style="display: none; flex-direction: column; height: 100vh;">
            <header>
                <div id="user-display">Loading...</div>
                <a href="#" onclick="clearName()" style="color: #007bff; text-decoration: none;">Change Name</a>
            </header>

            <div class="groups-section">
                <div class="group-controls">
                    <button onclick="createGroup()" id="createBtn" disabled>Create Group</button>
                    <input id="codeInput" placeholder="Enter code (e.g. 7FU54HUFG5)" maxlength="10" disabled>
                    <button onclick="joinGroup()" disabled>Join Group</button>
                </div>
                <select id="groupSelect" disabled><option>Select a group...</option></select>
                <div id="groupCode" class="current-group"></div>
            </div>

            <div id="messages" class="messages"></div>
            
            <form id="msgForm" class="message-form" onsubmit="sendMessage(event)">
                <input id="msgInput" placeholder="Type your message..." maxlength="500" disabled>
                <button type="submit" disabled>Send</button>
            </form>
        </div>
    </div>

    <script>
        let currentGroup = '';
        let user = localStorage.getItem('chatUser') || '';
        let hasName = !!user;

        function setUserName() {
            const name = document.getElementById('nameInput').value.trim();
            const errorDiv = document.getElementById('nameError');
            
            if (!name || name.length > 20) {
                errorDiv.textContent = 'Name required (max 20 chars)';
                return;
            }
            
            if (!/^[a-zA-Z0-9\s]{2,20}$/.test(name)) {
                errorDiv.textContent = 'Letters, numbers, spaces only';
                return;
            }
            
            user = name;
            hasName = true;
            localStorage.setItem('chatUser', user);
            showChat();
            errorDiv.textContent = '';
        }

        function clearName() {
            user = '';
            hasName = false;
            localStorage.removeItem('chatUser');
            localStorage.removeItem('currentGroup');
            document.getElementById('chat-section').style.display = 'none';
            document.getElementById('name-screen').style.display = 'flex';
            document.getElementById('nameInput').value = '';
            document.getElementById('nameError').textContent = '';
            currentGroup = '';
            document.getElementById('messages').innerHTML = '';
        }

        function showChat() {
            document.getElementById('name-screen').style.display = 'none';
            document.getElementById('chat-section').style.display = 'flex';
            document.querySelectorAll('#createBtn, #codeInput, #msgInput, #msgForm button, #groupSelect, button[onclick="joinGroup()"]').forEach(el => el.disabled = false);
            document.getElementById('user-display').textContent = `Logged in as ${user}`;
            loadGroups();
        }

        if (hasName) {
            showChat();
        }

        async function loadGroups() {
            try {
                const res = await fetch('/api/groups');
                const codes = await res.json();
                const select = document.getElementById('groupSelect');
                select.innerHTML = '<option>Select a group...</option>';
                codes.forEach(code => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = code;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Failed to load groups');
            }
        }

        async function createGroup() {
            try {
                const res = await fetch('/api/create-group', { method: 'POST' });
                const data = await res.json();
                joinGroup(data.code);
            } catch (e) {
                alert('Failed to create group');
            }
        }

        async function joinGroup(code = null) {
            const inputCode = code || document.getElementById('codeInput').value.trim
